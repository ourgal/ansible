---
- name: Configure windows admin
  hosts: nuc-windows-admin
  tags: admin
  tasks:
    - name: Debug variables
      ansible.builtin.debug:
        var: ansible_facts
    - name: Install choco pacakges
      tags: choco-install
      chocolatey.chocolatey.win_chocolatey:
        name: "{{ item }}"
        state: latest
      loop:
        - firefox
        - mpvio
        - visualstudio2026-workload-vctools
        - weasel
    - name: Uninstall choco pacakges
      chocolatey.chocolatey.win_chocolatey:
        name: "{{ item }}"
        state: absent
      loop:
        - gimp
    - name: Install init packages via scoop
      community.windows.win_scoop:
        name: '{{ item }}'
        global: false
        no_cache: true
      register: result
      retries: 3
      delay: 5
      until: result is not failed
      loop:
        - aria2
    - name: Add bucket
      community.windows.win_scoop_bucket:
        name: "{{ item }}"
        state: present
      loop:
        - extras
        - nerd-fonts
    - name: Install Microsoft Subsystem for Linux
      ansible.windows.win_optional_feature:
        name: Microsoft-Windows-Subsystem-Linux
        state: present
      register: wsl_status
    - name: Reboot if installing Linux Subsytem as feature requires it
      ansible.windows.win_reboot:
      when: wsl_status.reboot_required
    - name: Hide admin account
      tags: hide-admin
      ansible.windows.win_regedit:
        path: HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList
        type: dword
        name: Admin
        data: 0
    - name: Windows firewall rules
      tags: firewall
      block:
        - name: Croc firewall rule in
          community.windows.win_firewall_rule:
            name: Croc firewall rule in
            localport: 9009-9013
            action: allow
            direction: in
            protocol: tcp
            state: absent
            enabled: true
        - name: Croc firewall rule out
          community.windows.win_firewall_rule:
            name: Croc firewall rule out
            localport: 9009-9013
            action: allow
            direction: out
            protocol: tcp
            state: absent
            enabled: true
        - name: Deskflow firewall rule in
          community.windows.win_firewall_rule:
            name: Deskflow firewall rule tcp in
            localport: 24800-24801
            program: C:\Users\User\scoop\apps\deskflow\current\deskflow-core.exe
            action: allow
            protocol: tcp
            direction: in
            state: present
            enabled: true
        - name: Deskflow firewall rule out
          community.windows.win_firewall_rule:
            name: Deskflow firewall rule udp in
            localport: 24800-24801
            program: C:\Users\User\scoop\apps\deskflow\current\deskflow-core.exe
            action: allow
            protocol: udp
            direction: in
            state: present
            enabled: true
    - name: Set user groups
      tags: user-admin
      ansible.windows.win_user:
        name: User
        state: present
        groups:
          - Users
    - name: Start ssh-agent service
      tags: ssh-agent
      ansible.windows.win_service:
        name: ssh-agent
        state: started
        start_mode: auto
    - name: Update openssh
      tags: openssh
      chocolatey.chocolatey.win_chocolatey:
        name: openssh
        state: latest
        allow_prerelease: true
        package_params: /SSHServerFeature
    - name: Optimize powershell
      tags: optimize-powershell
      ansible.windows.win_shell: |
        function Optimize-Assemblies {
            param (
                [string]$assemblyFilter = "Microsoft.PowerShell.",
                [string]$activity = "Native Image Installation"
            )

            try {
                # Get the path to the ngen executable dynamically
                $ngenPath = [System.IO.Path]::Combine([Runtime.InteropServices.RuntimeEnvironment]::GetRuntimeDirectory(), "ngen.exe")

                # Check if ngen.exe exists
                if (-Not (Test-Path $ngenPath)) {
                    Write-Host "Ngen.exe not found at $ngenPath. Make sure .NET Framework is installed."
                    return
                }

                # Get a list of loaded assemblies
                $assemblies = [AppDomain]::CurrentDomain.GetAssemblies()

                # Filter assemblies based on the provided filter
                $filteredAssemblies = $assemblies | Where-Object { $_.FullName -ilike "$assemblyFilter*" }

                if ($filteredAssemblies.Count -eq 0) {
                    Write-Host "No matching assemblies found for optimization."
                    return
                }

                foreach ($assembly in $filteredAssemblies) {
                    # Get the name of the assembly
                    $name = [System.IO.Path]::GetFileName($assembly.Location)

                    # Display progress
                    Write-Progress -Activity $activity -Status "Optimizing $name"

                    # Use Ngen to install the assembly
                    Start-Process -FilePath $ngenPath -ArgumentList "install `"$($assembly.Location)`"" -Wait -WindowStyle Hidden
                }

                Write-Host "Optimization complete."
            } catch {
                Write-Host "An error occurred: $_"
            }
        }

        # Optimize PowerShell assemblies:
        Optimize-Assemblies -assemblyFilter "Microsoft.PowerShell."
    - name: Add game user
      tags: game-user
      ansible.windows.win_user:
        name: Game
        password_expired: false
        password_never_expires: true
        state: present
        groups:
          - Users
          - Administrators
- name: Configure windows user
  hosts: nuc-windows-user
  tags: user
  tasks:
    - name: Install aria2 and lessmsi via scoop
      community.windows.win_scoop:
        name: '{{ item }}'
        global: false
        no_cache: true
      register: result
      retries: 3
      delay: 5
      until: result is not failed
      loop:
        - aria2
        - lessmsi
    - name: Update scoop config
      tags: scoop-config
      block:
        - name: Facts
          ansible.builtin.gather_facts:
          when: ansible_facts is not defined
        - name: Check scoop config file
          ansible.windows.win_stat:
            path: "{{ ansible_facts.user_dir }}\\.config\\scoop\\config.json"
          register: scoop_config_stat
        - name: Get scoop config content
          ansible.windows.slurp:
            src: "{{ ansible_facts.user_dir }}\\.config\\scoop\\config.json"
          register: scoop_config_content
          when: scoop_config_stat.stat.exists is true
        - name: Set scoop config
          vars:
            config:
              use_lessmsi: true
              aria2-enabled: true
              aria2-warning-enabled: false
              use_sqlite_cache: true
              force_update: true
              use_external_7zip: false
          ansible.windows.win_copy:
            dest: "{{ ansible_facts.user_dir }}\\.config\\scoop\\config.json"
            content: "{{ scoop_config_content.content | b64decode | from_json | combine(config) | to_json }}"
          when: scoop_config_stat.stat.exists is true
        - name: Set scoop config
          vars:
            config:
              use_lessmsi: true
              aria2-enabled: true
              aria2-warning-enabled: false
              use_sqlite_cache: true
              force_update: true
              use_external_7zip: false
          ansible.windows.win_copy:
            dest: "{{ ansible_facts.user_dir }}\\.config\\scoop\\config.json"
            content: "{{ config | to_json }}"
          when: scoop_config_stat.stat.exists is false
    - name: Install 7zip and git via scoop
      community.windows.win_scoop:
        name: '{{ item }}'
        global: false
        no_cache: true
      register: result
      retries: 3
      delay: 5
      until: result is not failed
      loop:
        - 7zip
        - git
    - name: Using external 7zip
      tags: scoop-config
      block:
        - name: Facts
          ansible.builtin.gather_facts:
          when: ansible_facts is not defined
        - name: Check scoop config file
          ansible.windows.win_stat:
            path: "{{ ansible_facts.user_dir }}\\.config\\scoop\\config.json"
          register: scoop_config_stat
        - name: Get scoop config content
          ansible.windows.slurp:
            src: "{{ ansible_facts.user_dir }}\\.config\\scoop\\config.json"
          register: scoop_config_content
          when: scoop_config_stat.stat.exists is true
        - name: Set scoop config
          vars:
            config:
              use_external_7zip: true
          ansible.windows.win_copy:
            dest: "{{ ansible_facts.user_dir }}\\.config\\scoop\\config.json"
            content: "{{ scoop_config_content.content | b64decode | from_json | combine(config) | to_json }}"
          when: scoop_config_stat.stat.exists is true
        - name: Set scoop config
          vars:
            config:
              use_external_7zip: true
          ansible.windows.win_copy:
            dest: "{{ ansible_facts.user_dir }}\\.config\\scoop\\config.json"
            content: "{{ config | to_json }}"
          when: scoop_config_stat.stat.exists is false
    - name: Add bucket
      community.windows.win_scoop_bucket:
        name: "{{ item }}"
        state: present
      loop:
        - extras
        - nerd-fonts
    - name: Update scoop
      tags: scoop-update
      block:
        - name: Facts
          ansible.builtin.gather_facts:
          when: ansible_facts is not defined
        - name: Update scoop
          ansible.windows.win_shell: "{{ ansible_facts.user_dir }}/scoop/apps/scoop/current/bin/scoop.ps1 update"
        - name: Update scoop packages
          ansible.windows.win_shell: "{{ ansible_facts.user_dir }}/scoop/apps/scoop/current/bin/scoop.ps1 update --all"
        - name: Remove scoop cache
          ansible.windows.win_shell: "{{ ansible_facts.user_dir }}/scoop/apps/scoop/current/bin/scoop.ps1 cache remove *"
        - name: Clean up scoop packages
          ansible.windows.win_shell: "{{ ansible_facts.user_dir }}/scoop/apps/scoop/current/bin/scoop.ps1 cleanup --all"
    - name: Install main packages via scoop
      tags: scoop-main
      community.windows.win_scoop:
        name: "{{ item }}"
        state: present
        global: false
        no_cache: true
      register: result
      retries: 3
      delay: 5
      until: result is not failed
      loop:
        - clink
        - clink-completions
        - cmder-full
        - pwsh
        - nu
        - yori
        - fastfetch
        - ntop
        - btop
        - which
        - ttyper
        - fd
        - bat
        - less
        - rnr
        - shasum
        - zoxide
        - coreutils
        - nircmd
        - grep
        - ripgrep
        - dua
        - dust
        - tealdeer
        - sd
        - eza
        - duf
        - navi
        - unrar
        - unzip
        - mcfly
        - atuin
        - starship
        - aichat
        - croc
        - cwrsync
        - dufs
        - miniserve
        - portal
        - rclone
        - syncthing
        # hash check filed
        # - ffsend
        - dos2unix
        - goodbyedpi
        - innounp
        - gsudo
        - nssm
        - pipx
        - winget
        - clipboard
        - adb
        - scrcpy
        - cacert
        - scoop-search
        - hugo
        - exiftool
        - imagemagick
        - vim
        - helix
        - neovim
        - ffmpeg
        - git-annex
        - everything-cli
        - jj
        - git-bug
        - gh
        - git-lfs
        - git-absorb
        - diff-so-fancy
        - delta
        - git-crypt
        - gitui
        - gitql
        - gallery-dl
        - yt-dlp
        - gpg
        - openssl
        - gopass
        - sops
        - dog
        - nali
        - nmap
        - q-dns
        - tcping
        - pandoc
        - broot
        - fzf
        - chezmoi
        - lf
        - yazi
        - chsrc
        - editorconfig
        - autocorrect
        - taplo
        - tombi
        - ruff
        - perl
        - nodejs-lts
        - yarn
        - pnpm
        - tectonic
        - yamlfmt
        - haskell
        - haskell-cabal
        - haskell-language-server
        - stack
        - rust
        - make
        - task
        - msys2
        - shellcheck
        - binutils
    - name: Install extras packages via scoop
      tags: scoop-extras
      community.windows.win_scoop:
        name: '{{ item }}'
        global: false
        no_cache: true
      register: result
      retries: 3
      delay: 5
      until: result is not failed
      loop:
        - kdeconnect
        - autohotkey
        - autoclicker
        # install failed
        # - calibre
        # windows can't set default browser to this
        # - firefox
        - brave
        - qutebrowser
        - ungoogled-chromium
        - telegram
        - windowsdesktop-runtime-lts
        - sioyek
        - sumatrapdf
        - zeal
        - libreoffice
        - wpsoffice
        - aria-ng-gui
        - eget
        - transmission
        - transgui
        - notepadplusplus
        - vscodium
        - emacs
        - lunarvim
        - gcc
        - anki
        - cfssl
        - age
        - keepassxc
        - mc
        - vifm
        - doublecmd
        - locale-emulator
        - ludusavi
        - playnite
        - sunshine
        - lazygit
        - gitu
        - nomacs
        - qview
        - oculante
        - gimp
        - photodemon
        - photoflare
        - qmk-toolbox
        - vial
        - kanata
        - komokana
        - qalculate
        - fiddler
        - siyuan-note
        - qrscan
        - rustdesk
        - tightvnc
        - flameshot
        - television
        - carapace-bin
        - ttdl
        - sfsu
        - psfzf
        - psreadline
        - winspy
        - windhawk
        - glazewm
        - zebar
        - komorebi
        - yasb
        - whkd
        - flclash
        - diskgenius
        - smartmontools
        - crystaldiskinfo
        - wiztree
        - flow-launcher
        - dhcp-server
        - hourglass
        - copyq
        - bleachbit
        - everything
        - deskflow
        - coretemp
        - bulk-crap-uninstaller
        - windows-terminal
        - alacritty
        - wezterm
        - espanso
        - copytranslator
        - rufus
        - ventoy
        - ani-cli
        - jellyfin-mpv-shim
        - vlc
        # install failed
        # - miru
        # installed via choco
        # - mpv
        - handbrake
        - openboard
    - name: Install nerd fonts packages via scoop
      tags: scoop-fonts
      community.windows.win_scoop:
        name: '{{ item }}'
        global: false
        no_cache: true
      register: result
      retries: 3
      delay: 5
      until: result is not failed
      loop:
        - Maple-Mono-NF-CN
    - name: Add pipx bin path to PATH
      tags: path
      ansible.windows.win_path:
        state: present
        scope: user
        elements: '%userprofile%\.local\bin'
    - name: Install pipx packages
      tags: pipx-install
      ansible.windows.win_shell: "pipx install {{ item }}"
      loop:
        - advance-touch
        - xonsh[full]
        - mutagen
        - jedi-language-server
        - python-lsp-server
    - name: Add cargo bin path to PATH
      tags: path
      ansible.windows.win_path:
        state: present
        scope: user
        elements: '%userprofile%\.cargo\bin'
    - name: Install cargo packages
      tags: cargo-install
      ansible.windows.win_shell: "cargo install --locked --git {{ item }}"
      loop:
        - https://github.com/estin/simple-completion-language-server.git
    - name: Install npm packages
      tags: npm
      ansible.windows.win_shell: npm install -g "{{ item }}"
      loop:
        - prettier
        - vscode-langservers-extracted
        - yaml-language-server
        - "@ansible/ansible-language-server"
    - name: Facts
      tags: user-env
      ansible.builtin.gather_facts:
      when: ansible_facts.user_dir is not defined
    - name: Set home environment variable
      tags: user-env
      ansible.windows.win_environment:
        state: present
        name: HOME
        value: "{{ ansible_facts.user_dir }}"
        level: user
    - name: Add doom bin path to PATH
      tags: path
      ansible.windows.win_path:
        state: present
        scope: user
        elements: '%userprofile%\.emacs.d\bin'
    - name: Set rime as default input method
      ansible.windows.win_regedit:
        path: HKCU:\Keyboard Layout\Preload
        name: 1
        data: 00000804
    - name: Set en as second input method
      ansible.windows.win_regedit:
        path: HKCU:\Keyboard Layout\Preload
        name: 2
        data: 00000409
- name: Configure windows game user
  hosts: nuc-windows-game
  tags: game
  tasks:
    - name: Debug variables
      ansible.builtin.debug:
        var: ansible_facts
    - name: Install aria2 and lessmsi via scoop
      community.windows.win_scoop:
        name: '{{ item }}'
        global: false
        no_cache: true
      register: result
      retries: 3
      delay: 5
      until: result is not failed
      loop:
        - aria2
        - lessmsi
    - name: Update scoop config
      tags: scoop-config
      block:
        - name: Facts
          ansible.builtin.gather_facts:
          when: ansible_facts is not defined
        - name: Check scoop config file
          ansible.windows.win_stat:
            path: "{{ ansible_facts.user_dir }}\\.config\\scoop\\config.json"
          register: scoop_config_stat
        - name: Get scoop config content
          ansible.windows.slurp:
            src: "{{ ansible_facts.user_dir }}\\.config\\scoop\\config.json"
          register: scoop_config_content
          when: scoop_config_stat.stat.exists is true
        - name: Set scoop config
          vars:
            config:
              use_lessmsi: true
              aria2-enabled: true
              aria2-warning-enabled: false
              use_sqlite_cache: true
              force_update: true
              use_external_7zip: false
          ansible.windows.win_copy:
            dest: "{{ ansible_facts.user_dir }}\\.config\\scoop\\config.json"
            content: "{{ scoop_config_content.content | b64decode | from_json | combine(config) | to_json }}"
          when: scoop_config_stat.stat.exists is true
        - name: Set scoop config
          vars:
            config:
              use_lessmsi: true
              aria2-enabled: true
              aria2-warning-enabled: false
              use_sqlite_cache: true
              force_update: true
              use_external_7zip: false
          ansible.windows.win_copy:
            dest: "{{ ansible_facts.user_dir }}\\.config\\scoop\\config.json"
            content: "{{ config | to_json }}"
          when: scoop_config_stat.stat.exists is false
    - name: Install 7zip and git via scoop
      community.windows.win_scoop:
        name: '{{ item }}'
        global: false
        no_cache: true
      register: result
      retries: 3
      delay: 5
      until: result is not failed
      loop:
        - 7zip
        - git
    - name: Using external 7zip
      tags: scoop-config
      block:
        - name: Facts
          ansible.builtin.gather_facts:
          when: ansible_facts is not defined
        - name: Check scoop config file
          ansible.windows.win_stat:
            path: "{{ ansible_facts.user_dir }}\\.config\\scoop\\config.json"
          register: scoop_config_stat
        - name: Get scoop config content
          ansible.windows.slurp:
            src: "{{ ansible_facts.user_dir }}\\.config\\scoop\\config.json"
          register: scoop_config_content
          when: scoop_config_stat.stat.exists is true
        - name: Set scoop config
          vars:
            config:
              use_external_7zip: true
          ansible.windows.win_copy:
            dest: "{{ ansible_facts.user_dir }}\\.config\\scoop\\config.json"
            content: "{{ scoop_config_content.content | b64decode | from_json | combine(config) | to_json }}"
          when: scoop_config_stat.stat.exists is true
        - name: Set scoop config
          vars:
            config:
              use_external_7zip: true
          ansible.windows.win_copy:
            dest: "{{ ansible_facts.user_dir }}\\.config\\scoop\\config.json"
            content: "{{ config | to_json }}"
          when: scoop_config_stat.stat.exists is false
    - name: Add bucket
      community.windows.win_scoop_bucket:
        name: "{{ item }}"
        state: present
      loop:
        - extras
        - nerd-fonts
    - name: Add aki bucket
      community.windows.win_scoop_bucket:
        name: aki
        repo: https://github.com/akirco/aki-apps
        state: present
    - name: Install wegame
      tags: wegame
      community.windows.win_scoop:
        name: wegame
        state: present
        global: false
        no_cache: true
      register: result
      retries: 3
      delay: 5
      until: result is not failed
    - name: Remove aki bucket
      community.windows.win_scoop_bucket:
        name: aki
        repo: https://github.com/akirco/aki-apps
        state: absent
    - name: Install ldplayer
      community.windows.win_scoop:
        name: ldplayer
        global: false
        no_cache: true
      register: result
      retries: 3
      delay: 5
      until: result is not failed
    - name: Install bluestacks
      chocolatey.chocolatey.win_chocolatey:
        name: bluestacks
        state: latest
